## 役割

あなたは **シニアフルスタックエンジニア兼UIデザイナー** です。以下の仕様に従い、**ゼロから動く家系図Webアプリ** を実装し、`pnpm dev` で起動して、トップページから家系図の作成〜編集〜CSV出力〜印刷PDF（ブラウザ印刷）まで完了する状態にしてください。

---

## プロジェクト要件（MVP）

* **フロント/バック**: Next.js 14（App Router, TypeScript）
* **UI**: Tailwind CSS + shadcn/ui（極力少ないコンポーネントでOK）
* **グラフ**: React Flow（家系図レイアウトは横方向世代並び・自動整列）
* **DB（無料）**: **Vercel Postgres + Drizzle ORM**（Vercelデプロイに最適・無料枠）。

  * ※将来 Prisma/Neon に置換しやすいように層を分離（リポジトリ層）。
* **バリデーション**: zod + react-hook-form
* **CSV出力**: papaparse（クライアント側で生成・ダウンロード）
* **PDF**: 印刷用CSS（`@media print`）＋ブラウザの`印刷→PDF保存`
* **地図連携**: `https://www.google.com/maps/search/?api=1&query=<住所>` を新規タブで開くボタン
* **デプロイ**: Vercel（`@vercel/postgres` を使用）
* **ノンゴール（MVP外）**: 認証、画像アップロード、GEDCOM、Undo/Redo、共有リンク

---

## 画面/機能

1. **ダッシュボード** `/`

   * 家系図（Tree）の一覧表示（タイトル・作成日）
   * 「新規作成」モーダル（タイトル入力→作成）
   * 各行に「開く」「削除」アクション

2. **エディタ** `/trees/[id]`

   * 画面構成：

     * 上部ツールバー：

       * 追加: 「人物を追加」
       * 追加: 「配偶者関係を追加」「親子関係を追加」（右ペインで対象指定）
       * 出力: 「CSVエクスポート（2ファイル）」「印刷（印刷用CSSを適用）」
     * **中央**: React Flow キャンバス（ノード=人物、エッジ=関係）。

       * ノード表示：氏名（姓+名）/ 生没（例: 1980– ）
       * ドラッグ移動可能。レイアウトボタン（自動整列）あり。
     * **右ペイン**: 選択中の人物の詳細フォーム（react-hook-form + zod）

       * フィールド：姓・名・ふりがな・性別・生年月日・没年月日・住所・電話・メール・メモ
       * 「地図で開く」ボタン（住所をURLエンコードしてGoogle Maps検索へ）
       * 親・配偶者の追加UI（検索/選択）
       * 保存/削除ボタン
   * 整合性ガード：

     * 自分自身への関係禁止
     * `parent_child` で子の誕生日が親よりも前にならないよう警告（保存は可能だがトースト警告）
     * 重複関係（同一ペアの重複）をサーバーでユニーク化

3. **CSVエクスポート**

   * persons.csv：`id, treeId, familyName, givenName, kana, gender, birthDate, deathDate, address, phone, email, notes`
   * relationships.csv：`id, treeId, type, fromId, toId, startDate, endDate`
   * クライアント側でDBから取得→papaparseでCSV生成→2ファイルを個別ダウンロード

4. **印刷/PDF**

   * `@media print` を用意し、右ペインや不要UIを非表示、A4横で折り返し可能な見栄え最適化。

---

## ディレクトリ構成（例）

```
familytree/
  app/
    layout.tsx
    page.tsx                     # ダッシュボード
    trees/[id]/page.tsx          # エディタ
    api/
      trees/route.ts             # POST/GET（作成・一覧）
      trees/[id]/route.ts        # GET/DELETE（単体取得・削除）
      persons/route.ts           # POST（作成）
      persons/[id]/route.ts      # GET/PATCH/DELETE
      relationships/route.ts     # POST（作成）
      relationships/[id]/route.ts# DELETE
  components/
    ui/*                         # shadcnベース最小構成
    FamilyGraph.tsx              # React Flowラッパ
    PersonForm.tsx               # 右ペインのフォーム
    Toolbar.tsx                  # 上部ツールバー
  db/
    schema.ts                    # drizzle schema
    index.ts                     # drizzle client (@vercel/postgres)
    repo/
      persons.ts                 # DB操作（CRUD）
      relationships.ts
      trees.ts
  lib/
    types.ts                     # 型定義
    csv.ts                       # CSV生成（papaparse）
    layout.ts                    # グラフ自動整列（dagre or elkjs）
  styles/
    globals.css                  # Tailwind + 印刷CSS
  drizzle.config.ts
  package.json
  README.md
```

---

## 依存関係

* ランタイム: `next` `react` `react-dom`
* UI: `tailwindcss` `clsx` `lucide-react` `@radix-ui/react-dialog`
* グラフ: `reactflow`（React Flow） + 自動整列用に `dagre` か `elkjs`のどちらか
* フォーム/検証: `react-hook-form` `zod` `@hookform/resolvers`
* データ/日付: `dayjs`
* DB: `@vercel/postgres` `drizzle-orm` `drizzle-kit`
* CSV: `papaparse`
* ユーティリティ: `nanoid`

**開発**: `@types/node` `@types/react` `@types/react-dom` `postcss` `autoprefixer` `drizzle-kit` `typescript`

---

## Drizzle スキーマ（Postgres）

```ts
// db/schema.ts
import { pgTable, varchar, text, timestamp, uuid, pgEnum } from "drizzle-orm/pg-core";

export const genderEnum = pgEnum('gender', ['male','female','other','unknown']);
export const relEnum = pgEnum('relationship_type', ['parent_child','spouse','adoption']);

export const trees = pgTable('trees', {
  id: uuid('id').primaryKey().defaultRandom(),
  title: varchar('title', { length: 120 }).notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

export const persons = pgTable('persons', {
  id: uuid('id').primaryKey().defaultRandom(),
  treeId: uuid('tree_id').notNull().references(() => trees.id, { onDelete: 'cascade' }),
  familyName: varchar('family_name', { length: 120 }).notNull(),
  givenName: varchar('given_name', { length: 120 }).notNull(),
  kana: varchar('kana', { length: 240 }),
  gender: genderEnum('gender').default('unknown'),
  birthDate: varchar('birth_date', { length: 10 }), // ISO yyyy-mm-dd（簡易）
  deathDate: varchar('death_date', { length: 10 }),
  address: text('address'),
  phone: varchar('phone', { length: 60 }),
  email: varchar('email', { length: 160 }),
  notes: text('notes'),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

export const relationships = pgTable('relationships', {
  id: uuid('id').primaryKey().defaultRandom(),
  treeId: uuid('tree_id').notNull().references(() => trees.id, { onDelete: 'cascade' }),
  type: relEnum('type').notNull(),
  fromId: uuid('from_id').notNull().references(() => persons.id, { onDelete: 'cascade' }),
  toId: uuid('to_id').notNull().references(() => persons.id, { onDelete: 'cascade' }),
  startDate: varchar('start_date', { length: 10 }),
  endDate: varchar('end_date', { length: 10 }),
  createdAt: timestamp('created_at').defaultNow().notNull(),
});
```

```ts
// db/index.ts
import { drizzle } from 'drizzle-orm/vercel-postgres';
import { sql } from '@vercel/postgres';
export const db = drizzle(sql);
```

```ts
// drizzle.config.ts
import { defineConfig } from 'drizzle-kit';
export default defineConfig({
  out: './drizzle',
  schema: './db/schema.ts',
  dialect: 'postgresql',
  dbCredentials: { url: process.env.POSTGRES_URL! },
});
```

---

## API概要（App RouterのRoute Handlers）

* `POST /api/trees`：{ title } → 新規作成

* `GET  /api/trees`：一覧（id, title, createdAt）

* `GET  /api/trees/[id]`：単体（persons, relationships も同梱）

* `DELETE /api/trees/[id]`：ツリー削除（カスケード）

* `POST /api/persons`：人物作成

* `GET  /api/persons/[id]`：人物取得

* `PATCH /api/persons/[id]`：人物更新

* `DELETE /api/persons/[id]`：人物削除

* `POST /api/relationships`：関係作成（重複防止）

* `DELETE /api/relationships/[id]`：関係削除

**注意**: すべて `runtime = 'nodejs'`、Zodで入力検証、try/catch＋`NextResponse.json`、CORS不要（同一オリジン）。

---

## React Flow仕様

* **ノード**：`data: { id, label, birthDeath }`、角丸カード、ホバーで操作
* **エッジ**：

  * `parent_child`：直線/曲線（好みで）、方向矢印あり
  * `spouse`：点線または別色
* **自動整列**：`dagre` で世代（親→子）方向にレイアウト。ツールバーの「整列」ボタンで再計算。
* **操作**：

  * ノード選択→右ペインで編集
  * 右ペインで「親に追加」「配偶者に追加」（対象は検索/選択ドロップダウン）

---

## 右ペインフォーム（zod）

* 必須：姓・名
* optional：かな、性別（male/female/other/unknown）、生年月日、没年月日、住所、電話、メール、メモ
* 生年月日/没年月日：`YYYY-MM-DD` 文字列（zodで形式チェック）
* 住所が存在する場合「地図で開く」ボタン（`window.open('https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(address))`）

---

## CSVエクスポート（クライアント）

```ts
// lib/csv.ts（概念）
import Papa from 'papaparse';
export function downloadCsv(filename: string, rows: any[]) {
  const csv = Papa.unparse(rows);
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}
```

* persons, relationships をそれぞれDBからフェッチして `downloadCsv` を2回呼ぶ

---

## 印刷レイアウト（globals.css 抜粋）

```css
@media print {
  /* 右ペイン・ツールバーは非表示 */
  .no-print { display: none !important; }
  /* A4横向き最適化 */
  @page { size: A4 landscape; margin: 12mm; }
  /* グラフのノード/テキストを濃く */
  .print-strong { color: #000 !important; }
}
```

* ツールバーや右ペインに `no-print` クラスを付与
* React Flow コンテナは印刷時にスクロールせず全体表示可能にスタイル調整

---

## コード品質/UX要件

* すべての操作にトースト通知（成功/警告/失敗）
* フォームは`react-hook-form`で即時バリデーション
* API失敗時はメッセージ表示＋原因ログ（console.error）
* TypeScript型は `lib/types.ts` で集約しフロント/サーバ共有
* ESLint/Prettier整備

---

## セットアップ/コマンド（READMEにも記載）

1. `pnpm dlx create-next-app@latest familytree --ts --eslint --tailwind --app --src-dir --import-alias "@/*"`
2. `cd familytree`
3. 依存インストール：

   ```bash
   pnpm add drizzle-orm @vercel/postgres reactflow zod react-hook-form papaparse dayjs clsx lucide-react @radix-ui/react-dialog dagre nanoid
   pnpm add -D drizzle-kit @types/node @types/react @types/react-dom autoprefixer postcss typescript
   ```
4. Tailwind 初期化（create-next-appが自動生成）
5. Drizzle 設定ファイル `drizzle.config.ts` 追加
6. **環境変数**：`.env.local` に Vercel Postgres の `POSTGRES_URL` を設定（ローカルはVercelダッシュボードの接続情報を利用）
7. マイグレーション：

   ```bash
   pnpm drizzle-kit generate
   pnpm drizzle-kit push
   ```
8. 開発起動：`pnpm dev`

---

## 受け入れ基準（MVP Doneの定義）

* [ ] `/` でツリー一覧が表示され、新規作成→作成済みツリーへ遷移できる
* [ ] `/trees/[id]` で人物を追加し、右ペインで編集/保存/削除できる
* [ ] 親子/配偶者関係を追加/削除でき、React Flow に即時反映される
* [ ] レイアウト整列ボタンで、世代順に見やすく並ぶ
* [ ] 住所の「地図で開く」がGoogle Mapsで期待通り開く
* [ ] persons.csv / relationships.csv をダウンロードできる
* [ ] ブラウザの印刷（Ctrl/Cmd+P）で余計なUIが消え、家系図がA4横で綺麗に出力される
* [ ] Vercelへデプロイし、同じ操作が公開URLで再現できる

---

## 実装ガイド

* まず DB スキーマとAPIを完成→ダッシュボード→エディタの順で実装。
* React Flow のノード/エッジは最初はシンプルに。自動整列は `dagre` のレベル指定で親→子方向（LR）に。
* 入力検証は zod で最小限（必須・日付フォーマット）。
* SQLのユニーク性は `(tree_id, type, from_id, to_id)` で重複禁止インデックスを追加しても良い（Drizzleで可能なら追加）。
* APIはサーバーアクションではなく Route Handlers を使用（テストしやすさ優先）。
* 将来の認証導入を想定し、`treeId` をURL/クエリで明示（ユーザー境界を後でAuthに置換）。

---

## 仕上げ

* 最低限のダミーデータ Seed（ツリー1つ＋人物数名＋親子/配偶者）をREADMEに記載（任意）。
* READMEにローカル開発〜Vercelデプロイ手順、環境変数、既知の制限を記載。

---

## 納品形式

* プロジェクト一式（Next.js）を生成し、すべてのファイルを保存。`pnpm dev` で即実行可能。
* **未実装のTODOを残さない**。上記受け入れ基準をすべて満たす。

---

## 追加（任意の小機能・時間があれば）

* 人物検索（右ペイン上部に簡易検索）
* 年齢矛盾の軽い検知（警告トースト）
* グラフのスクリーンショットPNG保存（`html-to-image` など）

---

**以上の仕様で、実装を開始してください。** 実装が終わったら README に動作確認チェックリストを載せ、動作に必要な環境変数と手順が不足なく書かれていることを確認してください。
